<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>IMPERIUM ‚Äî JEA</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;900&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #030207;
  --rei: #FFD700; 
  --assassino: #ff0033;
  --conspirador: #9d4edd;
  --text: #ffffff;
  --glass: rgba(255, 255, 255, 0.08);
  --card-dark: #0f0f13;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
  margin: 0; background: var(--bg); color: var(--text); 
  font-family: 'Cinzel', serif; 
  height: 100dvh; overflow: hidden; display: flex; justify-content: center; align-items: center;
}

/* --- ESTILOS DA VINHETA (INTEGRADOS) --- */
#scr-teaser {
    position: fixed; inset: 0; z-index: 9999;
    background: radial-gradient(circle at center, #2a2200 0%, #030207 100%);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 30px; text-align: center; cursor: pointer;
}
.tap-hint {
    position: absolute; font-size: 1rem; text-transform: uppercase; 
    letter-spacing: 4px; font-weight: 800; color: var(--rei);
    animation: blink 2s infinite; z-index: 10;
}
.teaser-content { display: none; flex-direction: column; align-items: center; }
.teaser-content.active { display: flex; }
.flip-icon-teaser {
    font-size: 8rem; filter: drop-shadow(0 0 40px var(--rei));
    animation: flipAnimTeaser 6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}
@keyframes flipAnimTeaser {
    0% { transform: rotateY(0deg) scale(0.5); opacity: 0; }
    15% { transform: rotateY(180deg) scale(1.1); opacity: 1; }
    100% { transform: rotateY(1800deg) scale(1); opacity: 1; }
}
.teaser-title {
    font-size: 3.5rem; font-weight: 900; letter-spacing: 5px; color: var(--rei); margin-top: 20px;
    text-shadow: 0 0 30px rgba(255, 215, 0, 0.4); opacity: 0;
}
.teaser-title.show { animation: fadeInTeaser 1.2s forwards; }
.teaser-phrase {
    font-size: 1.1rem; line-height: 1.6; max-width: 340px; color: rgba(255,255,255,0.8); 
    margin-top: 15px; opacity: 0; font-family: 'Inter', sans-serif;
}
.teaser-phrase.show { animation: fadeInTeaser 1.5s forwards; }
@keyframes fadeInTeaser { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes blink { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

/* --- ESTILOS DO JOGO (ORIGINAIS) --- */
#app { width: 100%; max-width: 480px; height: 100%; position: relative; display: none; flex-direction: column; padding: 10px; }
.nav-top { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 1000; display: flex; justify-content: space-between; }
.btn-nav { background: var(--glass); border: 1px solid rgba(255,255,255,0.2); color: #fff; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; backdrop-filter: blur(10px); }
.screen { display: none; flex-direction: column; width: 100%; height: 100%; padding: 10px; text-align: center; position: relative; justify-content: center; }
.screen.active { display: flex; }
.card-container { width: 280px; height: 400px; perspective: 1200px; margin: 10px auto; }
.card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
.card-inner.flipped { transform: rotateY(180deg); }
.card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 35px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow: hidden; }
.card-front { background: linear-gradient(135deg, #1a1a20, #0a0a0c); }
.card-back { background: var(--card-dark); transform: rotateY(180deg); border: 2px solid var(--rei); }
#r-role { font-size: 1.7rem; margin: 5px 0; width: 100%; }
#r-word { font-size: 2.1rem; color: #fff; width: 100%; }
button { width: 100%; padding: 16px; border-radius: 20px; border: none; font-size: 0.9rem; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.2s; margin-top: 5px; }
.btn-primary { background: #fff; color: #000; }
.btn-accent { background: var(--rei); color: #000; }
.btn-danger { background: var(--assassino); color: #fff; }
.btn-outline { background: var(--glass); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
#player-list { overflow-y:auto; flex:1; margin: 15px 0; width: 100%; }
.player-slot { display: flex; justify-content: space-between; align-items: center; background: var(--glass); padding: 10px 15px; border-radius: 15px; margin-bottom: 6px; }
.btn-del { background: rgba(255,0,0,0.15); color: #ff4444; width: auto; padding: 8px 15px; border-radius: 10px; font-size: 0.7rem; margin:0; }
.modal { position: absolute; inset: 0; background: rgba(0,0,0,0.98); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 5000; }
.modal-content { background: #111; padding: 25px; border-radius: 30px; border: 1px solid var(--rei); width: 100%; max-width: 400px; text-align: center; }
.voter-tag { background: var(--rei); color: #000; padding: 5px 15px; border-radius: 10px; font-weight: 900; margin-bottom: 15px; display: inline-block; }
.vote-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
.res-screen { position: fixed; inset: 0; z-index: 4000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
.res-bg-rei { background: radial-gradient(circle, #2a2200 0%, #030207 100%); border-top: 4px solid var(--rei); }
.res-bg-ass { background: radial-gradient(circle, #2a0000 0%, #030207 100%); border-top: 4px solid var(--assassino); }
</style>
</head>
<body>

<div id="scr-teaser" onclick="iniciarTeaser()">
    <div class="tap-hint" id="hint">Toque para proteger o Imp√©rio</div>
    <div class="teaser-content" id="content-teaser">
        <div class="flip-icon-teaser">üè∞</div>
        <div class="teaser-title" id="t-title">IMPERIUM</div>
        <div class="teaser-phrase" id="t-phrase">
            Entre coroas e punhais, a lealdade √© um luxo que poucos podem pagar. Quem voc√™ servir√° hoje?
        </div>
    </div>
</div>

<div id="app">
    <div class="nav-top">
        <button class="btn-nav" id="sound-toggle" onclick="toggleAudio()">üîä</button>
        <button class="btn-nav" onclick="openModal('modal-menu')">‚ò∞</button>
    </div>

    <div id="scr-setup" class="screen active">
        <h1 style="color: var(--rei); margin:0">IMPERIUM</h1>
        <p style="opacity:0.5; font-size: 0.8rem; margin-bottom:15px">NOMEIE OS NOBRES</p>
        <input id="in-name" placeholder="NOME DO NOBRE" style="width:100%; padding:15px; border-radius:15px; background:var(--glass); color:#fff; border:1px solid rgba(255,255,255,0.1); text-align:center;">
        <button class="btn-accent" onclick="addPlayer()">+ ADICIONAR</button>
        <div id="player-list"></div>
        <button class="btn-primary" onclick="tryStart()">CONVOCAR A CORTE</button>
    </div>

    <div id="scr-pass" class="screen">
        <p style="opacity:0.5">ENTREGUE PARA</p>
        <h1 id="pass-name" style="font-size: 2.5rem; color: var(--rei);">---</h1>
        <button class="btn-primary" onclick="showReveal()">ESTOU COM O APARELHO</button>
    </div>

    <div id="scr-reveal" class="screen">
        <div class="card-container" onclick="flipCard()">
            <div id="the-card" class="card-inner">
                <div class="card-face card-front">
                    <div style="font-size: 4rem; margin-bottom: 15px;">üè∞</div>
                    <p style="opacity:0.5">TOQUE PARA REVELAR</p>
                </div>
                <div class="card-face card-back">
                    <p style="font-size: 0.7rem; opacity: 0.5;">VOC√ä √â:</p>
                    <h1 id="r-role">PAPEL</h1>
                    <div id="r-word-box">
                        <p style="font-size: 0.6rem; opacity: 0.4; margin-top:10px">PALAVRA CHAVE</p>
                        <h2 id="r-word">---</h2>
                    </div>
                </div>
            </div>
        </div>
        <button id="btn-entendi" class="btn-accent" style="visibility:hidden" onclick="nextPlayer()">ENTENDI</button>
    </div>

    <div id="scr-question-intro" class="screen">
        <p style="opacity:0.5">INICIANDO CICLO <span id="cur-cycle-num">1</span></p>
        <h1 style="color: var(--rei); font-size: 2rem;">ORDEM DOS INTERROGAT√ìRIOS</h1>
        <p style="font-size: 0.8rem; opacity: 0.7; margin: 20px 0;">Respostas curtas. Proibido falar a palavra, sin√¥nimos ou rimar.</p>
        <button class="btn-primary" onclick="startQuestionTurn()">INICIAR TURNOS</button>
    </div>

    <div id="scr-question-pass" class="screen">
        <p style="opacity:0.5">VEZ DE PERGUNTAR</p>
        <h1 id="q-pass-name" style="font-size: 2.5rem; color: var(--rei);">---</h1>
        <button class="btn-primary" onclick="showQuestionSelect()">ESTOU COM O APARELHO</button>
    </div>

    <div id="scr-question-select" class="screen">
        <p style="opacity:0.5">PERGUNTADOR: <span id="q-active-name" style="color:var(--rei)">---</span></p>
        <h2 style="font-size: 1.2rem; margin-bottom: 20px;">ESCOLHA QUEM IR√Å RESPONDER:</h2>
        <div id="q-select-options" class="vote-grid" style="flex: 1; overflow-y: auto;"></div>
    </div>

    <div id="scr-question-action" class="screen">
        <p style="opacity:0.5">PERGUNTA EM VOZ ALTA</p>
        <div class="voter-tag" id="q-target-tag">PARA: ---</div>
        <div style="font-size: 4rem; margin: 20px 0;">üí¨</div>
        <p style="font-family: sans-serif; opacity: 0.8; padding: 0 20px;">Ap√≥s a resposta ser dada, passe para o pr√≥ximo turno.</p>
        <button class="btn-accent" onclick="nextQuestionTurn()">PR√ìXIMO TURNO</button>
    </div>

    <div id="scr-dramatic-end" class="screen">
        <div style="font-size: 6rem; margin-bottom: 20px; filter: drop-shadow(0 0 20px var(--assassino));">‚öñÔ∏è</div>
        <h1 style="color: var(--rei); font-size: 1.5rem;">FIM DOS INTERROGAT√ìRIOS</h1>
        <p style="opacity: 0.7; margin-bottom: 30px;">As m√°scaras est√£o prestes a cair. Chegou a hora da verdade.</p>
        <button class="btn-danger" onclick="startDebate()">IR PARA VOTA√á√ÉO</button>
    </div>

    <div id="scr-debate" class="screen">
        <p style="opacity:0.5">L√çDER DO TURNO: <span id="st-name" style="color:var(--rei)">---</span></p>
        <div id="timer" style="font-size: 5rem; font-weight: 900; margin: 10px 0;">01:00</div>
        <button class="btn-primary" onclick="initVote()">INICIAR VOTA√á√ÉO</button>
    </div>

    <div id="scr-voting" class="screen">
        <div class="voter-tag" id="voter-name">---</div>
        <p style="opacity:0.6; margin-bottom: 10px;">QUEM √â O ASSASSINO?</p>
        <div id="vote-options" class="vote-grid"></div>
    </div>

    <div id="res-screen" class="res-screen">
        <div id="res-icon" style="font-size: 7rem; margin-bottom: 10px;">üèÜ</div>
        <h1 id="res-title" style="font-size: 2.5rem; margin: 0; color: #fff;">T√çTULO</h1>
        <p id="res-desc" style="font-family: sans-serif; margin: 20px 0 40px; padding: 0 20px; line-height: 1.5;"></p>
        <button id="btn-last-chance" class="btn-danger" style="display:none" onclick="goLastChance()">√öLTIMA CHANCE</button>
        <button class="btn-primary" onclick="resetRound()">PR√ìXIMA RODADA</button>
    </div>

    <div id="scr-last-chance" class="screen">
        <h1 style="color:var(--assassino)">√öLTIMA CHANCE</h1>
        <p>O Assassino adivinhou o segredo?</p>
        <button class="btn-danger" onclick="finishGame(true)">SIM (ASSASSINO ESCAPA)</button>
        <button class="btn-primary" onclick="finishGame(false)">N√ÉO (REINO VENCE)</button>
    </div>

    <div id="modal-menu" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--rei)">MENU</h2>
            <button class="btn-outline" onclick="openModal('modal-score')">üèÜ Placar</button>
            <button class="btn-outline" onclick="openModal('modal-rules')">üìú Regras</button>
            <button class="btn-outline" onclick="location.reload()">üîÑ Reiniciar</button>
            <button class="btn-primary" onclick="window.location.href='./index.html'" style="margin-top:10px">Voltar ao Hub üè†</button>
            <button class="btn-accent" onclick="closeModal('modal-menu')" style="margin-top:20px">Fechar</button>
        </div>
    </div>

    <div id="modal-rules" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--rei)">REGRAS</h2>
            <p style="text-align:left; font-size:0.85rem; opacity:0.8;">
                1. O Rei e Conspiradores devem achar o Assassino.<br>
                2. O Assassino deve descobrir a palavra ou o Rei.<br>
                3. Se o Assassino for votado, ele tem a √öltima Chance. Se ele acertar o Rei ou a Palavra, ele vence a rodada!
            </p>
            <button class="btn-primary" onclick="closeModal('modal-rules')">FECHAR</button>
        </div>
    </div>

    <div id="modal-error" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--assassino)">ERRO</h2>
            <p>M√≠nimo de 3 jogadores!</p>
            <button class="btn-primary" onclick="closeModal('modal-error')">OK</button>
        </div>
    </div>

    <div id="modal-score" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--rei)">PLACAR</h2>
            <div id="score-list" style="margin: 20px 0;"></div>
            <button class="btn-primary" onclick="closeModal('modal-score')">VOLTAR</button>
        </div>
    </div>
</div>

<script>
// --- L√ìGICA DA VINHETA ---
let teaserIniciado = false;
function iniciarTeaser() {
    if (teaserIniciado) return;
    teaserIniciado = true;
    
    document.getElementById('hint').style.display = 'none';
    document.getElementById('content-teaser').classList.add('active');

    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    playS(110, 'triangle', 0.8, 0, 0.15); 
    playS(150, 'triangle', 0.8, 0.4, 0.1); 

    setTimeout(() => {
        document.getElementById('t-title').classList.add('show');
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(200, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 3);
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 1.5);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 3);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 3);
    }, 1500);

    setTimeout(() => { document.getElementById('t-phrase').classList.add('show'); }, 3200);

    setTimeout(() => {
        playS(220, 'sine', 1.5, 0, 0.1); 
        playS(440, 'sine', 1.0, 0, 0.05); 
    }, 5500);

    setTimeout(() => {
        document.getElementById('scr-teaser').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
    }, 7500);
}

function playS(f, t='sine', d=0.1, delay=0, vol=0.1) {
    const time = audioCtx.currentTime + delay;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = t; o.frequency.setValueAtTime(f, time);
    g.gain.setValueAtTime(vol, time);
    g.gain.exponentialRampToValueAtTime(0.0001, time + d);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(time); o.stop(time + d);
}

// --- L√ìGICA DO JOGO (INTEGRAL) ---
let players = [], roles = [], scores = {}, cur = 0, currentVoter = 0, votes = {};
let audioCtx = null, isMuted = false, timerInt;
let cycleCount = 0, totalCycles = 2, cycleOrder = [], turnIndex = 0;
const words = [
    {r:"PIZZA", c:"PASTEL"}, {r:"LUA", c:"SOL"}, {r:"AVI√ÉO", c:"CARRO"}, {r:"FOGO", c:"GELO"}, {r:"REI", c:"RAINHA"}, {r:"MAR", c:"RIO"}, {r:"OURO", c:"PRATA"}, {r:"LIVRO", c:"CADERNO"},
    {r:"CAF√â", c:"CH√Å"}, {r:"GATO", c:"CACHORRO"}, {r:"BANANA", c:"MA√á√É"}, {r:"C√âU", c:"MAR"}, {r:"TREM", c:"√îNIBUS"}, {r:"CHAVE", c:"CADEADO"}, {r:"SAPATO", c:"CHINELO"}, {r:"MESA", c:"CADEIRA"},
    {r:"FUTEBOL", c:"BASQUETE"}, {r:"GUITARRA", c:"PIANO"}, {r:"ESTRELA", c:"PLANETA"}, {r:"FACA", c:"GARFO"}, {r:"√ìCULOS", c:"LENTE"}, {r:"REL√ìGIO", c:"PULSEIRA"}, {r:"PORTA", c:"JANELA"}, {r:"COPO", c:"X√çCARA"},
    {r:"NARIZ", c:"BOCA"}, {r:"M√ÉO", c:"P√â"}, {r:"CAL√áA", c:"BERMUDA"}, {r:"CAMISA", c:"CASACO"}, {r:"CHUVA", c:"NEVE"}, {r:"VENTO", c:"TEMPESTADE"}, {r:"ILHA", c:"MONTANHA"}, {r:"FLORESTA", c:"DESERTO"},
    {r:"M√âDICO", c:"ENFERMEIRO"}, {r:"POLICIAL", c:"BOMBEIRO"}, {r:"PROFESSOR", c:"ALUNO"}, {r:"PADARIA", c:"A√áOUGUE"}, {r:"BANCO", c:"LOT√âRICA"}, {r:"CINEMA", c:"TEATRO"}, {r:"EST√ÅDIO", c:"GIN√ÅSIO"}, {r:"IGREJA", c:"TEMPLO"},
    {r:"BRASIL", c:"PORTUGAL"}, {r:"FRAN√áA", c:"IT√ÅLIA"}, {r:"JAP√ÉO", c:"CHINA"}, {r:"AVI√ÉO", c:"HELIC√ìPTERO"}, {r:"NAVIO", c:"SUBMARINO"}, {r:"BICICLETA", c:"MOTO"}, {r:"SKATE", c:"PATINS"}, {r:"FOGUETE", c:"SAT√âLITE"},
    {r:"LE√ÉO", c:"TIGRE"}, {r:"Tubar√£o", c:"Baleia"}, {r:"√Åguia", c:"Falc√£o"}, {r:"Cobra", c:"Lagarto"}, {r:"Elefante", c:"Girafa"}, {r:"Zebra", c:"Cavalo"}, {r:"Macaco", c:"Gorila"}, {r:"Urso", c:"Lobo"},
    {r:"BOLO", c:"TORTA"}, {r:"SORVETE", c:"PICOL√â"}, {r:"HAMB√öRGUER", c:"Cachorro-Quente"}, {r:"CERVEJA", c:"VINHO"}, {r:"SUCO", c:"REFRIGERANTE"}, {r:"ARROZ", c:"FEIJ√ÉO"}, {r:"CARNE", c:"PEIXE"}, {r:"OVO", c:"QUEIJO"},
    {r:"COMPUTADOR", c:"CELULAR"}, {r:"TELEVIS√ÉO", c:"R√ÅDIO"}, {r:"INTERNET", c:"WI-FI"}, {r:"MOUSE", c:"TECLADO"}, {r:"C√ÇMERA", c:"FILMADORA"}, {r:"L√ÇMPADA", c:"VELA"}, {r:"BATERIA", c:"PILHA"}, {r:"FONE", c:"CAIXA DE SOM"},
    {r:"CINZA", c:"PRETO"}, {r:"BRANCO", c:"BEGE"}, {r:"AZUL", c:"VERDE"}, {r:"VERMELHO", c:"ROSA"}, {r:"AMARELO", c:"LARANJA"}, {r:"ROXO", c:"LIL√ÅS"}, {r:"DOURADO", c:"PRATEADO"}, {r:"MARROM", c:"BEGE"},
    {r:"JANEIRO", c:"DEZEMBRO"}, {r:"DOMINGO", c:"S√ÅBADO"}, {r:"VER√ÉO", c:"INVERNO"}, {r:"OUTONO", c:"PRIMAVERA"}, {r:"MANH√É", c:"NOITE"}, {r:"TARDE", c:"MADRUGADA"}, {r:"ONTEM", c:"AMANH√É"}, {r:"HOJE", c:"AGORA"},
    {r:"DENTE", c:"L√çNGUA"}, {r:"OLHO", c:"ORELHA"}, {r:"CABELO", c:"BARBA"}, {r:"CORA√á√ÉO", c:"PULM√ÉO"}, {r:"SANGUE", c:"SUOR"}, {r:"SONO", c:"SONHO"}, {r:"RISO", c:"CHORO"}, {r:"GRITO", c:"SUSSURRO"},
    {r:"CASA", c:"APARTAMENTO"}, {r:"QUARTO", c:"SALA"}, {r:"COZINHA", c:"BANHEIRO"}, {r:"GARAGEM", c:"QUINTAL"}, {r:"TELHADO", c:"PAREDE"}, {r:"ESCADA", c:"ELEVADOR"}, {r:"TAPETE", c:"CORTINA"}, {r:"ESPELHO", c:"QUADRO"},
    {r:"ESCOLA", c:"FACULDADE"}, {r:"TRABALHO", c:"ESTUDO"}, {r:"PROVA", c:"TRABALHO"}, {r:"CANETA", c:"L√ÅPIS"}, {r:"BORRACHA", c:"R√âGUA"}, {r:"MOCHILA", c:"ESTOJO"}, {r:"PAPEL", c:"CARTOLINA"}, {r:"COLA", c:"TESOURA"},
    {r:"M√öSICA", c:"DAN√áA"}, {r:"FILME", c:"S√âRIE"}, {r:"DESENHO", c:"NOVELA"}, {r:"R√ÅDIO", c:"PODCAST"}, {r:"LIVRARIA", c:"BIBLIOTECA"}, {r:"POEMA", c:"CONTO"}, {r:"PINTURA", c:"ESCULTURA"}, {r:"FOTO", c:"V√çDEO"},
    {r:"REFRIGERADOR", c:"FOG√ÉO"}, {r:"MICRO-ONDAS", c:"FORNO"}, {r:"VASSOURA", c:"RODO"}, {r:"BALDE", c:"BACIA"}, {r:"SAB√ÉO", c:"AMACIANTE"}, {r:"ESPONJA", c:"PALHA DE A√áO"}, {r:"TOALHA", c:"LEN√áOL"}, {r:"TRAVESSEIRO", c:"COBERTOR"},
    {r:"MERCADO", c:"FEIRA"}, {r:"SHOPPING", c:"LOJA"}, {r:"FARM√ÅCIA", c:"HOSPITAL"}, {r:"PARQUE", c:"PRA√áA"}, {r:"ZOOL√ìGICO", c:"AQU√ÅRIO"}, {r:"CIRCO", c:"PARQUE DE DIVERS√ïES"}, {r:"MUSEU", c:"GALERIA"}, {r:"PONTE", c:"T√öNEL"},
    {r:"MOEDA", c:"NOTA"}, {r:"CARTEIRA", c:"BOLSA"}, {r:"ANEL", c:"BRINCO"}, {r:"COLAR", c:"PULSEIRA"}, {r:"PERFUME", c:"BATOM"}, {r:"ESCOVA", c:"PENTE"}, {r:"SABONETE", c:"SHAMPOO"}, {r:"DENTIFR√çCIO", c:"FIO DENTAL"},
    {r:"BOTA", c:"T√äNIS"}, {r:"MEIA", c:"CUECA"}, {r:"GRAVATA", c:"CINTO"}, {r:"LUVA", c:"TOUCA"}, {r:"GUARDA-CHUVA", c:"CAPA DE CHUVA"}, {r:"MALETA", c:"MOCHILA"}, {r:"FERRO", c:"A√áO"}, {r:"MADEIRA", c:"PEDRA"}
];

function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
function toggleAudio() { initAudio(); isMuted = !isMuted; document.getElementById('sound-toggle').innerText = isMuted ? "üîá" : "üîä"; }
function playSfx(f, d) { if(isMuted || !audioCtx) return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d); o.start(); o.stop(audioCtx.currentTime + d); }
function playArp(fs) { fs.forEach((f, i) => setTimeout(() => playSfx(f, 0.4), i * 85)); }

function openModal(id) { if(id === 'modal-score') renderScores(); document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function addPlayer() {
    initAudio();
    const inp = document.getElementById('in-name');
    const name = inp.value.trim().toUpperCase();
    if(!name) return;
    players.push(name);
    scores[name] = 0;
    inp.value = '';
    renderPlayerList();
    playSfx(523, 0.1);
}

function renderPlayerList() {
    const container = document.getElementById('player-list');
    container.innerHTML = players.map((p, i) => `
        <div class="player-slot"><b>${p}</b><button class="btn-del" onclick="removePlayer(${i})">REMOVER</button></div>
    `).join('');
}

function removePlayer(idx) {
    players.splice(idx, 1);
    renderPlayerList();
    playSfx(330, 0.1);
}

function tryStart() {
    if(players.length < 3) { openModal('modal-error'); return; }
    prepareRound();
}

function prepareRound() {
    let theme = words[Math.floor(Math.random()*words.length)];
    roles = [{n:"REI", w:theme.r, c:"var(--rei)"}, {n:"ASSASSINO", w:"???", c:"var(--assassino)"}];
    for(let i=2; i<players.length; i++) roles.push({n:"CONSPIRADOR", w:theme.c, c:"var(--conspirador)"});
    roles.sort(() => Math.random() - 0.5);
    cur = 0; 
    totalCycles = players.length >= 9 ? 3 : 2;
    cycleCount = 0;
    showPass();
}

function showPass() {
    document.getElementById('pass-name').innerText = players[cur];
    showScreen('scr-pass');
}

function showReveal() {
    document.getElementById('the-card').classList.remove('flipped');
    document.getElementById('btn-entendi').style.visibility = 'hidden';
    const r = roles[cur];
    document.getElementById('r-role').innerText = r.n;
    document.getElementById('r-role').style.color = r.c;
    document.getElementById('r-word').innerText = r.w;
    document.getElementById('r-word-box').style.display = (r.n === "ASSASSINO") ? "none" : "block";
    showScreen('scr-reveal');
}

function flipCard() {
    if(!document.getElementById('the-card').classList.contains('flipped')) {
        document.getElementById('the-card').classList.add('flipped');
        document.getElementById('btn-entendi').style.visibility = 'visible';
        playArp([440, 554, 659]);
    }
}

function nextPlayer() {
    cur++;
    if(cur < players.length) showPass();
    else initCycle();
}

// --- LOGICA DE CICLOS DE PERGUNTAS ---

function initCycle() {
    cycleCount++;
    if(cycleCount > totalCycles) {
        showDramaticEnd();
        return;
    }
    // Embaralha ordem dos jogadores para o ciclo
    cycleOrder = [...players].sort(() => Math.random() - 0.5);
    turnIndex = 0;
    document.getElementById('cur-cycle-num').innerText = cycleCount;
    showScreen('scr-question-intro');
    playArp([300, 400, 500]);
}

function startQuestionTurn() {
    const activePlayer = cycleOrder[turnIndex];
    document.getElementById('q-pass-name').innerText = activePlayer;
    showScreen('scr-question-pass');
}

function showQuestionSelect() {
    const activePlayer = cycleOrder[turnIndex];
    document.getElementById('q-active-name').innerText = activePlayer;
    const container = document.getElementById('q-select-options');
    container.innerHTML = "";
    
    players.forEach(p => {
        if(p !== activePlayer) {
            const btn = document.createElement('button');
            btn.className = 'btn-outline';
            btn.innerText = p;
            btn.onclick = () => selectTarget(p);
            container.appendChild(btn);
        }
    });
    showScreen('scr-question-select');
    playSfx(600, 0.1);
}

function selectTarget(targetName) {
    document.getElementById('q-target-tag').innerText = `PARA: ${targetName}`;
    showScreen('scr-question-action');
    playArp([600, 800]);
}

function nextQuestionTurn() {
    turnIndex++;
    if(turnIndex < cycleOrder.length) {
        startQuestionTurn();
    } else {
        initCycle();
    }
}

function showDramaticEnd() {
    showScreen('scr-dramatic-end');
    // Som dram√°tico de encerramento
    if(!isMuted && audioCtx) {
        const t = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(100, t);
        o.frequency.exponentialRampToValueAtTime(40, t + 2);
        g.gain.setValueAtTime(0.2, t);
        g.gain.linearRampToValueAtTime(0, t + 2);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(t + 2);
    }
}
// --- VOLTA PARA LOGICA ORIGINAL ---

function startDebate() {
    document.getElementById('st-name').innerText = players[Math.floor(Math.random()*players.length)];
    showScreen('scr-debate');
    let t = 60;
    clearInterval(timerInt);
    timerInt = setInterval(() => {
        t--; document.getElementById('timer').innerText = `00:${t.toString().padStart(2,'0')}`;
        if(t <= 10 && t > 0) playSfx(900, 0.05);
        if(t === 0) { clearInterval(timerInt); playArp([200, 100]); }
    }, 1000);
}

function initVote() {
    clearInterval(timerInt);
    currentVoter = 0; votes = {};
    players.forEach(p => votes[p] = 0);
    showVoteTurn();
}

function showVoteTurn() {
    const container = document.getElementById('vote-options');
    container.innerHTML = "";
    document.getElementById('voter-name').innerText = players[currentVoter];
    players.forEach((p, i) => {
        if(i !== currentVoter) {
            const btn = document.createElement('button');
            btn.className = 'btn-outline'; btn.innerText = p;
            btn.onclick = () => { playSfx(1000, 0.05); votes[p]++; currentVoter++; if(currentVoter < players.length) showVoteTurn(); else tally(); };
            container.appendChild(btn);
        }
    });
    showScreen('scr-voting');
}

function tally() {
    const assIdx = roles.findIndex(r => r.n === "ASSASSINO");
    const assName = players[assIdx];
    const mostVoted = Object.keys(votes).reduce((a, b) => votes[a] > votes[b] ? a : b);
    const res = document.getElementById('res-screen');
    res.style.display = "flex";
    
    if(mostVoted === assName) {
        res.className = "res-screen res-bg-rei";
        document.getElementById('res-icon').innerText = "‚öîÔ∏è";
        document.getElementById('res-title').innerText = "PEGUEI!";
        document.getElementById('res-desc').innerText = `O Assassino ${mostVoted} foi desmascarado!\nEle ter√° uma √öLTIMA CHANCE de escapar.`;
        document.getElementById('btn-last-chance').style.display = "block";
        playArp([523, 659, 783, 1046]);
    } else {
        res.className = "res-screen res-bg-ass";
        document.getElementById('res-icon').innerText = "üíÄ";
        document.getElementById('res-title').innerText = "TRAI√á√ÉO!";
        document.getElementById('res-desc').innerText = `Voc√™s exilaram ${mostVoted}, mas o Assassino era ${assName}!\nA Corte caiu em desgra√ßa.`;
        document.getElementById('btn-last-chance').style.display = "none";
        scores[assName] += 3;
        playArp([150, 120, 80]);
    }
}

function goLastChance() { document.getElementById('res-screen').style.display = "none"; showScreen('scr-last-chance'); }

function finishGame(assWon) {
    const assName = players[roles.findIndex(r => r.n === "ASSASSINO")];
    const res = document.getElementById('res-screen');
    res.style.display = "flex";
    document.getElementById('btn-last-chance').style.display = "none";

    if(assWon) {
        scores[assName] += 3;
        res.className = "res-screen res-bg-ass";
        document.getElementById('res-icon').innerText = "üî•";
        document.getElementById('res-title').innerText = "FUGA COM SUCESSO";
        document.getElementById('res-desc').innerText = "O Assassino descobriu os segredos e escapou! +3 Pontos.";
        playArp([100, 200, 300, 400]);
    } else {
        players.forEach(p => { if(p !== assName) scores[p] += 1; });
        res.className = "res-screen res-bg-rei";
        document.getElementById('res-icon').innerText = "üëë";
        document.getElementById('res-title').innerText = "JUSTI√áA FEITA";
        document.getElementById('res-desc').innerText = "O traidor falhou na sua miss√£o! +1 Ponto para a Corte.";
        playArp([800, 1000, 1200]);
    }
}

function resetRound() { document.getElementById('res-screen').style.display = "none"; prepareRound(); }
function renderScores() { document.getElementById('score-list').innerHTML = players.map(p => `<div class="player-slot"><b>${p}</b> <span>${scores[p]} PTS</span></div>`).join(''); }
function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
</script>
</body>
</html>